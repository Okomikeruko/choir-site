# Use Ubuntu 20.04 LTS as the base image
FROM ubuntu:latest

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Update and install dependencies
RUN apt-get update -qq && \ 
    apt-get install -y \
      autoconf \
      bison \
      build-essential \
      curl \
      git \
      libffi-dev \
      libgdbm-dev \
      libpq-dev \
      libreadline-dev \
      libncurses5-dev \
      libssl-dev \
      libyaml-dev \
      nodejs \
      unzip \
      wget \
      zlib1g-dev

# Import the repository signing key
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -

# Add the repository
RUN sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ jammy-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

RUN apt-get update -qq && apt-get install -y postgresql-15

# Download and install the AWS CLI
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
    unzip awscliv2.zip && \
    ./aws/install

# Clean up unnecessary files
RUN rm -rf awscliv2.zip ./aws

# Install rbenv and ruby-build
RUN git clone https://github.com/rbenv/rbenv.git ~/.rbenv
RUN git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
ENV PATH /root/.rbenv/bin:/root/.rbenv/shims:$PATH

# Install Ruby 3.1.3 and set it as default
RUN rbenv install 3.1.3
RUN rbenv global 3.1.3

# Set the working directory inside the container
WORKDIR /app

COPY . /app

RUN gem install bundler:2.2.28
RUN bundle install